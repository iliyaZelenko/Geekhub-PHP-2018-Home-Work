## Что это такое?

Библиотека для работы с протоколом Oauth2. Этот протокол позволяет получать данные пользователя по этому притоколу 
не используя учетные данны пользователя (логин, пароль).

Идею библиотеки я взял из [этой библиотеки](https://github.com/laravel/socialite), которой не раз пользовался. 
Я посмотрел как там реализованно в исходном коде, но это не значит что все скопированно :smile:, все написанно вручную и по своим идеям.

## Вкратнце как работать через Oauth2

### Регистрация клиента для сервиса

Сначала нужно для каждого сервиса зарегестрировать клиенты (они обычно называются приложения), 
в этих клиентах описывается ваше приложение, всегда указывается redirect_url 
(куда перенаправлять после подтвержденния действия на передачу информации или после ошибки), 
потом вам дают ID приложения и секретный ключ приложения.

Эти все данные нужно указывать при инициализации библиотеки:

```php
OauthProvidersManager::init([
    [
        'name' => 'google',
        'clientId' => '418799322900-hk88fkv35a3igd2hi6qibo2ej64p9kua.apps.googleusercontent.com',
        'clientSecret' => 'aNW5GbaBDoipDITEzn67aOeG',
        'redirectUrl' => 'http://localhost:8080/oauth/redirect/google'
    ],
    [
        'name' => 'github',
        'clientId' => '6351d734c1841cc6b7e6',
        'clientSecret' => '4307fc4127bc23309daff47f84517d6a58d5a72b',
        'redirectUrl' => 'http://localhost:8080/oauth/redirect/github'
    ],
    [
        'name' => 'facebook',
        'clientId' => '1877646002278860',
        'clientSecret' => 'fc7c4c93573912a66bb3c7e0fd3cc36f',
        'redirectUrl' => 'http://localhost:8080/oauth/redirect/facebook'
    ]
]);
```

Эти данные лучше не показывать хакерам, но для демки это не страшно.

### Перенаправление на страницу подтвержденния

Нужно перенаправить на страницу где пользователь согласится или откажет передавать свои данные 
(какие конкретно данные брать указывается в scopes).
После подтвержденния или ошибки сервис перенаправляет по указанному `redirect_url` где надо обрабатывать ошибку или успешное подтвержденние данных.
Если прошло успешно, то страница на которую перекинуло пользователя содержит GET параметр `code`. Этот код вместе с

- `client_id`
- `client_secret`
- `redirect_uri` (по моему не все требуют, как дополнительная информация чтобы подтвердить владельца клиента)

нужно отправлять чтобы получить `access_token` (токен доступа). 

### Использование токена доступа

`access_token` это главное что нужно, без него никак, также может приходить `refresh_token` — токен чтобы 
обновить главный токен (кто делал авторизацию для REST API тот в теме), и также прийти `expires_in`, это кол-во 
секунд через которые истечет токен доступа, когда обновляешь токен через `refresh_token` то это значение вместе с 
`access_token` приходят новыми.

И наконец этот токен доступа можно использовать для получения пользователя и других данных если он Вам это разрешил.
Например, можно получить id пользователя в сервисе, его почту, имя, аватар, ник.

В данной библиотеке все основные поля легко доступны через стандартизирвоанные методы, 
но и оригинального пользователя и все отсально можно без проблем получить.


### Поддерживаемые сервисы

Эта библиотека поддерживает 3 сервиса:

- Google
- Facebook
- Github

Но конечно можно легко добавлять другие сервисы (провайдеры), в том числе своих сайтов.

Клиент для Facebook в dev режиме, поэтому протокол работает только для разработчика, чтобы выйти из dev надо иметь https 
(новое правило фейсбука).

Обычно по этому протоколу получают данные пользователя, эта библиотека позволяет использовать единый интерфейс
для работы со всеми сервисами:

## Примеры

Получить редирект url нужного сервиса:

```php
OauthProvidersManager
    ::provider($provider)
    ::getAuthUrl();
```

Сделать редирект:

```php
OauthProvidersManager
    ::provider($provider)
    ::redirect();
```

Получить объект пользователя:

```php
OauthProvidersManager
    ::provider($provider)
    ::user();
```

Провайдеру можно легко менять настройки, например, вот так можно указать уровни доступа:

return OauthProvidersManager
    ::provider($provider)
    ::scopes($scopes[$provider] ?? [])
    ::redirect();

Объект пользователя предоставляет такие поля:

```php
$user = [
    // стандартизированные поля, которые есть в большинстве сервисов
    'user' => [
        'id' => $userObj->getId(),
        'name' => $userObj->getName(),
        'email' => $userObj->getEmail(),
        'avatar' => $userObj->getAvatar(),
        'nickname' => $userObj->getNickname()
    ],
    // оригинальный массив пользователя
    'originalUser' => $userObj->getOriginal(),
    // токен доступа
    'token' => $userObj->accessToken
];
```

## Demo

Библиотека может быть использованна в stateful и stateless (REST API) приложениях.

Есть демки этих двух типов приложений, в одно написанно на vue.

Чтобы работало на Nginx [нужно настроить](https://github.com/skipperbent/simple-php-router#setting-up-nginx).

## [Документация](https://iliyazelenko.github.io/Geekhub-PHP-2018-Home-Work-/).

Все задокументированно по стандарту PHPDoc (первый опыт), для рендиринга документации использовал инструмент Sami (как в Laravel).



